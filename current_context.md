# ğŸ§  xPostingAgent-as-a-Service â€” Current Context

This document captures the full current state of the codebase, to ensure any developer can continue work without losing context. **Update this file after each major dev session.**

---

## ğŸ“ Project Folder Structure (as of 2025-06-23)

```
xPostingAgent-as-a-Service/
â”‚
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py
â”‚   â”œâ”€â”€ config.py
â”‚   â”œâ”€â”€ database.py
â”‚   â”œâ”€â”€ dependencies.py                  # âœ… shared Depends() providers
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ users.py
â”‚   â”‚   â”œâ”€â”€ requests.py
â”‚   â”‚   â”œâ”€â”€ summaries.py
â”‚   â”‚   â”œâ”€â”€ research_sources.py
â”‚   â”‚   â”œâ”€â”€ topic_source_usage.py
â”‚   â”‚   â”œâ”€â”€ content_queue.py
â”‚   â”‚   â”œâ”€â”€ thread_metadata.py
â”‚   â”‚   â””â”€â”€ user_configurations.py
â”‚   â”œâ”€â”€ agents/
â”‚   â”‚   â”œâ”€â”€ topic_agent.py
â”‚   â”‚   â”œâ”€â”€ research_agent.py
â”‚   â”‚   â”œâ”€â”€ summary_agent.py             # âœ… NEW â€” consolidates summaries and key points
â”‚   â”‚   â””â”€â”€ content_agent.py
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ google_search.py
â”‚   â”‚   â”œâ”€â”€ ai_source_discovery.py
â”‚   â”‚   â”œâ”€â”€ source_verification.py
â”‚   â”‚   â”œâ”€â”€ embedding_similarity.py
â”‚   â”‚   â”œâ”€â”€ source_reuse.py
â”‚   â”‚   â”œâ”€â”€ content_validation.py
â”‚   â”‚   â”œâ”€â”€ content_queue.py             # âœ… approve/schedule/post logic
â”‚   â”‚   â””â”€â”€ platform_publisher.py        # âœ… Typefully + X platform posting logic
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ hash.py
â”‚   â”‚   â””â”€â”€ offensive_filter.py
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ auth.py
â”‚   â”‚   â””â”€â”€ content_queue.py             # âœ… routes for queue lifecycle
â”‚
â”œâ”€â”€ app/tests/
â”‚   â”œâ”€â”€ test_topic_agent.py
â”‚   â”œâ”€â”€ test_topic_source_usage.py
â”‚   â”œâ”€â”€ test_run_research_agent.py
â”‚   â”œâ”€â”€ test_content_agent.py
â”‚   â”œâ”€â”€ test_content_queue.py            # âœ… tests for approval/schedule/post
â”‚   â””â”€â”€ test_platform_publisher.py       # âœ… Typefully integration unit tests
â”‚
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ insert_test_content.py
â”‚   â”œâ”€â”€ run_post_content.py
â”‚   â”œâ”€â”€ reset_content_status.py
â”‚   â””â”€â”€ full_pipeline_test.py            # âœ… NEW â€” end-to-end test: topic â†’ post
â”‚
â”œâ”€â”€ alembic/
â”‚   â””â”€â”€ versions/
â”‚       â””â”€â”€ <... autogenerated migrations ...>
â”‚
â”œâ”€â”€ .env
â”œâ”€â”€ requirements.txt
â””â”€â”€ current_context.md
```

---

## ğŸ§  Agent Layer

### agents/topic\_agent.py

* `generate_content_topic(request_id, original_topic, user_config, content_type, user_id)`

  * Uses LLM to transform a general topic into a more specific and engaging one.
  * Updates the request with the refined topic and sets status to "researching".

### agents/research\_agent.py

* `generate_research_sources(request_id, content_topic, user_id, limit, preference)`

  * Combines AI and Google search.
  * Deduplicates, verifies, scores, stores relevant sources in `research_sources`.
  * Continues gracefully if 0 sources found.

### agents/summary\_agent.py âœ… NEW

* `generate_and_store_summary(request_id, verified_sources, target_length, content_type, user_id)`

  * Combines source summaries, deduplicates key points.
  * Prompts LLM for combined summary and key points.
  * Stores result in `summaries` table.

### agents/content\_agent.py

* `create_content(db, request, summary, research_sources, user_config)`

  * Builds LLM prompt using summary, config, and content type.
  * Generates full thread or article.
  * Stores in `content_queue`; saves `thread_metadata` if applicable.

* `build_content_prompt(...)`

  * Dynamically builds prompt from summary + config.

* `split_into_tweets(text, max_count)`

  * Splits by newline (naÃ¯ve method). Future improvement: smarter tweet segmentation.

* `select_top_citations(sources, max_count)`

  * Ranks citations by relevance + freshness.

---

## ğŸ”§ Services Layer

### services/content\_validation.py

* `validate_article_length(content, max_words)`
* `validate_thread_structure(tweets, max_tweets, max_chars)`

### services/content\_queue.py

* `approve_content(content_id, db)`

  * Validates format and offensive check.
  * âœ… Handles both JSON and plain text tweet formats gracefully.

* `schedule_content(content_id, scheduled_for, db)`

  * âœ… Now uses timezone-aware datetime.
  * Validates future timestamp.

* `post_content(content_id, db, dry_run=False)`

  * Posts to platform based on `content.platform`
  * âœ… Typefully integration implemented.
  * Saves `platform_posted_id` and `post_response`.

### services/platform\_publisher.py

* `post_to_typefully(content, scheduled_for=None)`
* `post_to_x(...)` â€” Not implemented

---

## ğŸ” Dependencies

### dependencies.py

* `get_db()`
* `get_current_user()` â€” Uses JWT auth

---

## ğŸ” Utils

### utils/hash.py

* `hash_string_sha256(string)`

### utils/offensive\_filter.py

* `check_offensive_content(text)`

---

## ğŸ”– Models

Key models include:

* `users.py`, `requests.py`, `summaries.py`, `research_sources.py`, `content_queue.py`, `thread_metadata.py`, `topic_source_usage.py`, `user_configurations.py`, `system_configurations.py`, `user_sessions.py`

All use SQLAlchemy with PostgreSQL fields.

---

## ğŸ”Œ API Layer

### api/auth.py

* POST `/auth/register`, `/auth/login`

### api/content\_queue.py

* PUT `/content/queue/{content_id}/approve`
* PUT `/content/queue/{content_id}/schedule`
* POST `/content/queue/{content_id}/post`

---

## ğŸ§ª Tests

* `test_content_queue.py` â€” lifecycle tests
* `test_platform_publisher.py` â€” mocks post to Typefully
* âœ… `scripts/full_pipeline_test.py` performs:

  * DB wipe
  * User + config creation
  * Submit topic â†’ all agent calls â†’ approve â†’ schedule â†’ post

---

## âš™ï¸ Config

### .env

* Includes API keys, secret, Redis, PostgreSQL, etc.

### config.py

* Loads `.env` settings via `pydantic.BaseSettings`

---

## ğŸ”® Future Enhancements & TODOs

* [ ] Replace hardcoded validation values (e.g. 280 chars, 5000 words) with per-user config fallback to system defaults
* [ ] Replace `db.query().get()` with `db.get()` in services and tests
* [ ] Use timezone-aware `datetime.now(UTC)` instead of deprecated `datetime.utcnow()` â€” âœ… partially done
* [ ] Add Celery for async post-at-scheduled-time with jitter logic
* [ ] Add system config overrides for platforms (e.g. post window, max retries)
* [ ] Add retry/backoff logic for failed posting
* [ ] Track all transitions (draft â†’ approved â†’ scheduled/post) in an audit table
* [ ] Implement Twitter OAuth and posting support
* [ ] Add integration tests for `/content/queue/{id}/post` endpoint
* [ ] Improve tweet splitting: LLM format or NLP-based structure
* [ ] Investigate Typefully timezone mismatch for schedule preview
* [ ] Improve fallback logic when source count = 0 (e.g. skip citation logic)

---

ğŸ“… You are now fully up to date as of 2025-06-23 (post full pipeline test).
