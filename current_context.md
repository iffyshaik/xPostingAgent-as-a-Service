# ğŸ§  xPostingAgent-as-a-Service â€” Current Context

This document captures the full current state of the codebase, to ensure any developer can continue work without losing context. **Update this file after each major dev session.**

---

## ğŸ“ Project Folder Structure (as of 2025-06-23)

```
xPostingAgent-as-a-Service/
â”‚
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py
â”‚   â”œâ”€â”€ config.py
â”‚   â”œâ”€â”€ database.py
â”‚   â”œâ”€â”€ dependencies.py                  # âœ… shared Depends() providers
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ users.py
â”‚   â”‚   â”œâ”€â”€ requests.py
â”‚   â”‚   â”œâ”€â”€ summaries.py
â”‚   â”‚   â”œâ”€â”€ research_sources.py
â”‚   â”‚   â”œâ”€â”€ topic_source_usage.py
â”‚   â”‚   â”œâ”€â”€ content_queue.py
â”‚   â”‚   â””â”€â”€ thread_metadata.py
â”‚   â”œâ”€â”€ agents/
â”‚   â”‚   â”œâ”€â”€ topic_agent.py
â”‚   â”‚   â”œâ”€â”€ research_agent.py
â”‚   â”‚   â””â”€â”€ content_agent.py
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ google_search.py
â”‚   â”‚   â”œâ”€â”€ ai_source_discovery.py
â”‚   â”‚   â”œâ”€â”€ source_verification.py
â”‚   â”‚   â”œâ”€â”€ embedding_similarity.py
â”‚   â”‚   â”œâ”€â”€ source_reuse.py
â”‚   â”‚   â”œâ”€â”€ content_validation.py
â”‚   â”‚   â”œâ”€â”€ content_queue.py             # âœ… approve/schedule/post logic
â”‚   â”‚   â””â”€â”€ platform_publisher.py        # âœ… NEW â€“ Typefully + X platform posting logic
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ hash.py
â”‚   â”‚   â””â”€â”€ offensive_filter.py
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ auth.py
â”‚   â”‚   â””â”€â”€ content_queue.py             # âœ… routes for queue lifecycle
â”‚
â”œâ”€â”€ app/tests/
â”‚   â”œâ”€â”€ test_topic_agent.py
â”‚   â”œâ”€â”€ test_topic_source_usage.py
â”‚   â”œâ”€â”€ test_run_research_agent.py
â”‚   â”œâ”€â”€ test_content_agent.py
â”‚   â”œâ”€â”€ test_content_queue.py            # âœ… tests for approval/schedule/post
â”‚   â””â”€â”€ test_platform_publisher.py       # âœ… NEW â€“ unit tests for Typefully integration
â”‚
â”œâ”€â”€ scripts/                             # âœ… Developer utility scripts
â”‚   â”œâ”€â”€ insert_test_content.py           # Insert test rows into content_queue
â”‚   â”œâ”€â”€ run_post_content.py              # Run post_content() manually
â”‚   â””â”€â”€ reset_content_status.py          # Reset content row for re-testing
â”‚
â”œâ”€â”€ alembic/
â”‚   â””â”€â”€ versions/
â”‚       â””â”€â”€ <... autogenerated migrations ...>
â”‚
â”œâ”€â”€ .env
â”œâ”€â”€ requirements.txt
â””â”€â”€ current_context.md
```

---

## ğŸ§  Agent Layer

### agents/topic\_agent.py

* `generate_refined_topic()`: Refines a user-submitted topic into a more specific and engaging one using LLM. Stores in requests.content\_topic.

### agents/research\_agent.py

* `generate_research_sources()`: Full pipeline to fetch, verify, deduplicate, and rank sources (AI + Google). Saves to research\_sources and logs access issues to topic\_source\_usage.

### agents/content\_agent.py

* `create_content()`: Main entry point for the content generation agent. Builds prompt, calls LLM, validates output, stores in content\_queue.
* `build_content_prompt()`: Dynamically constructs the LLM prompt using persona, tone, style, tweet/article specs, and citation config.
* `select_top_citations()`: Selects top N sources based on relevance and freshness scores.
* `check_offensive_content()`: Uses a profanity library to detect NSFW or sensitive content based on .env flag.
* `store_thread_metadata()`: (If content is a thread) stores structured output including tweet objects and citation tweets.

---

## ğŸ”§ Services Layer

### services/content\_validation.py

* `validate_article_length(content, max_words)`: Raises ValueError if word count exceeds limit.
* `validate_thread_structure(tweets, max_tweets, max_chars)`: Flags (but does not truncate) tweets that exceed allowed length; returns tweets unchanged.

### services/content\_queue.py

* `approve_content(content_id, db)`: Validates structure and checks offensiveness. Updates status to "approved".
* `schedule_content(content_id, scheduled_for, db)`: Updates status to "scheduled" with future timestamp.
* `post_content(content_id, db, dry_run=False)`: Routes post to correct platform. Stores result or error.

### services/platform\_publisher.py âœ… NEW

* `post_to_typefully(content, scheduled_for=None)`: Posts to Typefully via API. Adds `threadify` and `share`. Uses `X-API-KEY`. Returns `platform_posted_id` and full response.
* `post_to_x(...)`: Placeholder for Twitter/X integration. Not yet implemented.

---

## ğŸ” Dependencies

### dependencies.py

* `get_db()`: Yields SQLAlchemy session from SessionLocal.
* `get_current_user()`: Extracts user ID from JWT token using `OAuth2PasswordBearer`.

---

## ğŸ” Utils

### utils/hash.py

* `hash_string_sha256(string)`: SHA256 hashing for anonymising topics and URLs (used in source reuse).

### utils/offensive\_filter.py

* `check_offensive_content(text)`: Returns True if profanity is detected using better\_profanity.

---

## ğŸ”– Models

### models/users.py

* `id`, `email`, `password_hash`, `subscription_tier`, `api_quota_daily`, `api_quota_used_today`, `created_at`, `updated_at`

### models/requests.py

* `id`, `user_id`, `original_topic`, `content_topic`, `status`, `content_type`, `auto_post`, `platform`, `thread_tweet_count`, `max_article_length`, `include_source_citations`, `citation_count`, `created_at`, `updated_at`, `error_message`
* ğŸ”§ TODO: Switch to Session.get() where `.query().get()` is used

### models/summaries.py

* Contains unsupported ARRAY column (`Text[]`) for SQLite tests

### models/research\_sources.py

* `id`, `request_id`, `user_id`, `source_type`, `url`, `title`, `author`, `verification_status`, `relevance_score`, `freshness_score`, `summary`, `key_points[]`, `is_used`

### models/topic\_source\_usage.py

* Tracks reuse of sources per topic hash

### models/content\_queue.py

* `id`, `request_id`, `user_id`, `content_type`, `generated_content`, `status`, `scheduled_for`, `platform`, `post_response`, `error_message`, `created_at`, `posted_at`
* âœ… NEW: `platform_posted_id`: external ID for auditing or reply threading

### models/thread\_metadata.py

* `id`, `content_queue_id`, `requested_tweet_count`, `actual_tweet_count`, `max_tweet_length`, `thread_structure`, `citation_tweets`, `created_at`

---

## ğŸ”Œ API Layer

### api/auth.py

* POST `/auth/register`, `/auth/login` â€” Delegates to `auth_service.py`

### api/content\_queue.py

* PUT `/content/queue/{content_id}/approve`: Validates and approves draft
* PUT `/content/queue/{content_id}/schedule`: Schedules future posting
* POST `/content/queue/{content_id}/post`: Posts to platform (now fully implemented for Typefully)

---

## ğŸ§ª Tests

### tests/test\_content\_agent.py

* Validates prompt, filters, citation logic

### tests/test\_content\_queue.py

* `test_approve_content_success()`: Asserts status moves to "approved"
* `test_schedule_content_success()`: Asserts future time is accepted
* `test_post_content_success()`: Asserts post logic and result stored
* âš ï¸ Uses `ContentQueue.__table__.create()` to avoid ARRAY errors with SQLite

### tests/test\_platform\_publisher.py âœ… NEW

* `test_post_to_typefully_success()`: Mocks successful post
* `test_post_to_typefully_failure()`: Mocks 400 error and validates exception raised

---

## âš™ï¸ Config

### .env

* `ENABLE_OFFENSIVE_CHECK=true`
* `TYPEFULLY_API_KEY`, `X_API_KEY`, `X_API_SECRET` are required for posting

### config.py

* Loads secrets, keys, AI providers

---

## ğŸ”® Future Enhancements & TODOs

* [ ] Replace hardcoded validation values (e.g. 280 chars, 5000 words) with per-user config fallback to system defaults
* [ ] Replace `db.query().get()` with `db.get()` in services and tests
* [ ] Use timezone-aware `datetime.now(UTC)` instead of deprecated `datetime.utcnow()`
* [ ] Add Celery for async post-at-scheduled-time with jitter logic
* [ ] Add system config overrides for platforms (e.g. post window, max retries)
* [ ] Add retry/backoff logic for failed posting
* [ ] Track all transitions (draft â†’ approved â†’ scheduled/post) in an audit table
* [ ] Implement Twitter OAuth and posting support
* [ ] Add integration tests for `/content/queue/{id}/post` endpoint

---

ğŸ“… You are now fully up to date as of 2025-06-23.
