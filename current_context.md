# ğŸ§  xPostingAgent-as-a-Service â€” Current Context

This document captures the full current state of the codebase, to ensure any developer can continue work without losing context. **Update this file after each major dev session.**

---

## ğŸ“ Project Folder Structure (as of 2025-06-24)

```
xPostingAgent-as-a-Service/
â”‚
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py
â”‚   â”œâ”€â”€ config.py
â”‚   â”œâ”€â”€ database.py
â”‚   â”œâ”€â”€ dependencies.py
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ users.py
â”‚   â”‚   â”œâ”€â”€ requests.py
â”‚   â”‚   â”œâ”€â”€ summaries.py
â”‚   â”‚   â”œâ”€â”€ research_sources.py
â”‚   â”‚   â”œâ”€â”€ topic_source_usage.py
â”‚   â”‚   â”œâ”€â”€ content_queue.py
â”‚   â”‚   â”œâ”€â”€ thread_metadata.py
â”‚   â”‚   â””â”€â”€ user_configurations.py
â”‚   â”œâ”€â”€ agents/
â”‚   â”‚   â”œâ”€â”€ topic_agent.py
â”‚   â”‚   â”œâ”€â”€ research_agent.py
â”‚   â”‚   â”œâ”€â”€ summary_agent.py
â”‚   â”‚   â””â”€â”€ content_agent.py
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ google_search.py
â”‚   â”‚   â”œâ”€â”€ ai_source_discovery.py
â”‚   â”‚   â”œâ”€â”€ source_verification.py
â”‚   â”‚   â”œâ”€â”€ embedding_similarity.py
â”‚   â”‚   â”œâ”€â”€ source_reuse.py
â”‚   â”‚   â”œâ”€â”€ content_validation.py
â”‚   â”‚   â”œâ”€â”€ content_queue.py
â”‚   â”‚   â””â”€â”€ platform_publisher.py
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ hash.py
â”‚   â”‚   â””â”€â”€ offensive_filter.py
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ auth.py
â”‚   â”‚   â”œâ”€â”€ content_queue.py
â”‚   â”‚   â”œâ”€â”€ content_requests.py
â”‚   â”‚   â”œâ”€â”€ agent_pipeline.py
â”‚   â”‚   â”œâ”€â”€ user_config_seed.py
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â””â”€â”€ content_requests.py
â”‚
â”œâ”€â”€ app/tests/
â”‚   â”œâ”€â”€ test_topic_agent.py
â”‚   â”œâ”€â”€ test_topic_source_usage.py
â”‚   â”œâ”€â”€ test_run_research_agent.py
â”‚   â”œâ”€â”€ test_content_agent.py
â”‚   â”œâ”€â”€ test_content_queue.py
â”‚   â””â”€â”€ test_platform_publisher.py
â”‚
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ insert_test_content.py
â”‚   â”œâ”€â”€ run_post_content.py
â”‚   â”œâ”€â”€ reset_content_status.py
â”‚   â””â”€â”€ full_pipeline_test.py
â”‚
â”œâ”€â”€ alembic/
â”‚   â””â”€â”€ versions/
â”‚       â””â”€â”€ <... autogenerated migrations ...>
â”‚
â”œâ”€â”€ .env
â”œâ”€â”€ requirements.txt
â””â”€â”€ current_context.md
```

---

## ğŸ§  Agent Layer

### agents/topic\_agent.py

* `generate_content_topic(...)`

### agents/research\_agent.py

* `generate_research_sources(...)`

### agents/summary\_agent.py

* `generate_and_store_summary(...)`

### agents/content\_agent.py

* `create_content(...)`
* `build_content_prompt(...)`
* `split_into_tweets(...)`
* `select_top_citations(...)`

---

## ğŸ”§ Services Layer

### services/content\_validation.py

* `validate_article_length(...)`
* `validate_thread_structure(...)`

### services/content\_queue.py

* `approve_content(...)`
* `schedule_content(...)`
* `post_content(...)`

### services/platform\_publisher.py

* `post_to_typefully(...)`
* `post_to_x(...)`

---

## ğŸ” Auth & Dependencies

### api/auth.py

* `POST /auth/register`, `POST /auth/login`

### dependencies.py

* `get_db()`
* `get_current_user()`

---

## ğŸ” Utils

### utils/hash.py

* `hash_string_sha256(...)`

### utils/offensive\_filter.py

* `check_offensive_content(...)`

---

## ğŸ”– Models

Key models:

* `users`, `requests`, `summaries`, `research_sources`, `content_queue`, `thread_metadata`, `topic_source_usage`, `user_configurations`, `system_configurations`, `user_sessions`

---

## ğŸ”Œ API Layer

### api/content\_requests.py

* `POST /content/requests`

### api/agent\_pipeline.py

* `POST /pipeline/{request_id}/topic`
* `POST /pipeline/{request_id}/research`
* `POST /pipeline/{request_id}/summary`
* `POST /pipeline/{request_id}/content`

### api/content\_queue.py

* `PUT /content/queue/{id}/approve`
* `PUT /content/queue/{id}/schedule`
* `POST /content/queue/{id}/post`

### api/user\_config\_seed.py

* `POST /dev/create-user-config`

### api/users.py

* `GET /users/configurations`
  - Returns the current user's configuration
  - Auto-creates a default config row if missing

* `PUT /users/configurations`
  - Updates the user_configurations row
  - Accepts optional fields: `persona`, `tone`, `style`, `language`, `platform_preference`, `research_preference`

### schemas/user_configurations.py

* `UpdateUserConfig(BaseModel)`
  - Optional fields for updating user configuration
  - Used in `PUT /users/configurations`

---

## ğŸ§ª Tests

* `test_content_queue.py` â€” lifecycle tests
* `test_platform_publisher.py` â€” mocks post to Typefully
* âœ… `scripts/full_pipeline_test.py` performs full agent + post pipeline
* âœ… As of 2025-06-24: Full pipeline tested manually through Swagger

---

## ğŸ”® Future Enhancements & TODOs

### ğŸ” Existing TODOs

* [ ] Replace hardcoded validation values (e.g. 280 chars, 5000 words) with per-user config fallback to system defaults
* [ ] Replace `db.query().get()` with `db.get()` in services and tests
* [ ] Use timezone-aware `datetime.now(UTC)` instead of deprecated `datetime.utcnow()` â€” âœ… partially done
* [ ] Add Celery for async post-at-scheduled-time with jitter logic
* [ ] Add system config overrides for platforms (e.g. post window, max retries)
* [ ] Add retry/backoff logic for failed posting
* [ ] Track all transitions (draft â†’ approved â†’ scheduled/post) in an audit table
* [ ] Implement Twitter OAuth and posting support
* [ ] Add integration tests for `/content/queue/{id}/post` endpoint
* [ ] Improve tweet splitting: LLM format or NLP-based structure
* [ ] Investigate Typefully timezone mismatch for schedule preview
* [ ] Improve fallback logic when source count = 0 (e.g. skip citation logic)

### ğŸ§ª New Issues from Manual Pipeline Test

* [ ] Improve Research Agent fallback logic when 0 usable sources are found

  * Retry with alternate keywords
  * Use dev-mode mock sources
  * Lower relevance threshold in dev
* [ ] Research Agent doesnâ€™t currently extract/generate summaries for sources

  * Add summary + key\_point extraction during verification
  * Use LLM if metadata is good
* [ ] Summary Agent uses `summary IS NOT NULL` filter; sources with empty strings are skipped

  * Confirm data is properly stored (non-empty string)
  * Improve visibility/logging of inputs
* [ ] Add logging before LLM call in summary agent to inspect empty cases
* [ ] Add temporary endpoint to list all sources for a request for manual QA
* [ ] Consider auto-creating user\_config upon registration to prevent topic agent failure

---

ğŸ“… You are now fully up to date as of 2025-06-24 (after full manual pipeline test via Swagger UI).
